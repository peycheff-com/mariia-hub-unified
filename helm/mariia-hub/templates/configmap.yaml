{{- if .Values.configMaps.enabled }}
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "mariia-hub.configMapName" . }}
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "mariia-hub.labels" . | nindent 4 }}
    app.kubernetes.io/component: configmap
  {{- if .Values.configMaps.annotations }}
  annotations:
    {{- toYaml .Values.configMaps.annotations | nindent 4 }}
  {{- end }}
data:
  # Application Configuration
  NODE_ENV: "{{ .Values.env.NODE_ENV }}"
  APP_NAME: "{{ .Values.env.APP_NAME }}"
  APP_VERSION: "{{ .Values.env.APP_VERSION }}"
  APP_URL: "{{ .Values.env.APP_URL }}"
  DEFAULT_CURRENCY: "{{ .Values.env.DEFAULT_CURRENCY }}"
  DEFAULT_LOCALE: "{{ .Values.env.DEFAULT_LOCALE }}"
  ENABLE_ANALYTICS: "{{ .Values.env.ENABLE_ANALYTICS }}"
  ENABLE_PWA: "{{ .Values.env.ENABLE_PWA }}"
  LOG_LEVEL: "{{ .Values.env.LOG_LEVEL }}"

  # Build Information
  BUILD_TARGET: "production"
  BUILD_SHA: "{{ .Values.build.sha }}"
  BUILD_DATE: "{{ .Values.build.date }}"
  BUILD_TIME: "{{ .Values.build.time }}"

  # Feature Flags
  ENABLE_SOCIAL_LOGIN: "true"
  ENABLE_DEBUG: "false"
  ENABLE_OFFLINE: "true"

  # Performance Settings
  CACHE_TTL: "300"
  MAX_CACHE_SIZE: "100"
  ENABLE_BUNDLING: "true"
  ENABLE_MINIFICATION: "true"

  # Security Settings
  ENABLE_CSRF: "true"
  ENABLE_CONTENT_SECURITY_POLICY: "true"
  SESSION_TIMEOUT: "3600"
  MAX_LOGIN_ATTEMPTS: "5"

  # Booking System Settings
  BOOKING_TIMEZONE: "Europe/Warsaw"
  MAX_BOOKING_PER_DAY: "50"
  BOOKING_CONFIRMATION_TIMEOUT: "1800"
  ENABLE_BOOKING_NOTIFICATIONS: "true"

  # External Services
  STRIPE_WEBHOOK_ENDPOINT: "/api/stripe/webhook"
  BOOKSY_SYNC_ENABLED: "true"
  BOOKSY_SYNC_INTERVAL: "300"

  # Monitoring and Logging
  ENABLE_PERFORMANCE_MONITORING: "true"
  ENABLE_ERROR_TRACKING: "true"
  METRICS_ENABLED: "true"

  # Content Delivery
  CDN_ENABLED: "true"
  CDN_URL: "https://cdn.mariaborysevych.com"
  ASSET_VERSIONING: "true"

  # Database Connection Pool Settings
  DB_POOL_MIN: "2"
  DB_POOL_MAX: "20"
  DB_CONNECTION_TIMEOUT: "30"

  # Redis Settings
  REDIS_PREFIX: "mariia_hub:"
  REDIS_SESSION_PREFIX: "session:"
  REDIS_CACHE_PREFIX: "cache:"
  REDIS_LOCK_PREFIX: "lock:"

  # Email Configuration
  EMAIL_FROM: "noreply@mariaborysevych.com"
  EMAIL_SUPPORT: "support@mariaborysevych.com"
  SMTP_HOST: "smtp.sendgrid.net"
  SMTP_PORT: "587"

  # File Upload Settings
  MAX_FILE_SIZE: "10485760"
  ALLOWED_FILE_TYPES: "jpg,jpeg,png,gif,pdf"
  UPLOAD_PATH: "/uploads"

  # API Rate Limiting
  API_RATE_LIMIT: "100"
  API_RATE_WINDOW: "60"
  API_BURST_LIMIT: "200"

  # SEO Settings
  SITE_TITLE: "Mariia Hub - Beauty & Fitness Booking"
  SITE_DESCRIPTION: "Premium beauty and fitness booking platform in Warsaw"
  SITE_AUTHOR: "Mariia Borysevych"
  OG_IMAGE: "/assets/og-image.jpg"

  # Social Media Links
  FACEBOOK_URL: "https://facebook.com/mariaborysevych"
  INSTAGRAM_URL: "https://instagram.com/mariaborysevych"
  LINKEDIN_URL: "https://linkedin.com/in/mariaborysevych"

  # Nginx Configuration
  nginx.conf: |
    user nginx;
    worker_processes auto;
    error_log /var/log/nginx/error.log warn;
    pid /var/run/nginx.pid;

    events {
        worker_connections 1024;
        use epoll;
        multi_accept on;
    }

    http {
        include /etc/nginx/mime.types;
        default_type application/octet-stream;

        # Logging format
        log_format main '$remote_addr - $remote_user [$time_local] "$request" '
                        '$status $body_bytes_sent "$http_referer" '
                        '"$http_user_agent" "$http_x_forwarded_for" '
                        'rt=$request_time uct="$upstream_connect_time" '
                        'uht="$upstream_header_time" urt="$upstream_response_time"';

        access_log /var/log/nginx/access.log main;

        # Performance optimizations
        sendfile on;
        tcp_nopush on;
        tcp_nodelay on;
        keepalive_timeout 65;
        types_hash_max_size 2048;
        server_tokens off;

        # Gzip compression
        gzip on;
        gzip_vary on;
        gzip_proxied any;
        gzip_comp_level 6;
        gzip_types
            text/plain
            text/css
            text/xml
            text/javascript
            application/json
            application/javascript
            application/xml+rss
            application/atom+xml
            image/svg+xml;

        # Security headers
        add_header X-Frame-Options "SAMEORIGIN" always;
        add_header X-Content-Type-Options "nosniff" always;
        add_header X-XSS-Protection "1; mode=block" always;
        add_header Referrer-Policy "strict-origin-when-cross-origin" always;
        add_header Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline' https://www.googletagmanager.com https://www.google-analytics.com; style-src 'self' 'unsafe-inline'; img-src 'self' data: https:; font-src 'self' data:; connect-src 'self' https://api.stripe.com https://*.supabase.co;" always;

        # Rate limiting
        limit_req_zone $binary_remote_addr zone=api:10m rate=10r/s;
        limit_req_zone $binary_remote_addr zone=login:10m rate=1r/s;

        # Upstream configuration
        upstream mariia_hub_backend {
            least_conn;
            server localhost:8080 max_fails=3 fail_timeout=30s;
            keepalive 32;
        }

        # Server configuration
        server {
            listen 8080;
            server_name _;
            root /usr/share/nginx/html;
            index index.html;

            # Health check endpoint
            location /health {
                access_log off;
                return 200 "healthy\n";
                add_header Content-Type text/plain;
            }

            # Security
            location ~ /\. {
                deny all;
                access_log off;
                log_not_found off;
            }

            # Static assets with caching
            location ~* \.(jpg|jpeg|png|gif|ico|css|js|woff|woff2|ttf|eot|svg)$ {
                expires 1y;
                add_header Cache-Control "public, immutable";
                add_header X-Content-Type-Options nosniff;
                access_log off;
            }

            # HTML files with shorter cache
            location ~* \.html$ {
                expires 1h;
                add_header Cache-Control "public, must-revalidate";
            }

            # API rate limiting
            location /api/ {
                limit_req zone=api burst=20 nodelay;
                proxy_pass http://mariia_hub_backend;
                proxy_set_header Host $host;
                proxy_set_header X-Real-IP $remote_addr;
                proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                proxy_set_header X-Forwarded-Proto $scheme;
            }

            # Login rate limiting
            location /api/auth/login {
                limit_req zone=login burst=5 nodelay;
                proxy_pass http://mariia_hub_backend;
                proxy_set_header Host $host;
                proxy_set_header X-Real-IP $remote_addr;
                proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                proxy_set_header X-Forwarded-Proto $scheme;
            }

            # SPA fallback
            location / {
                try_files $uri $uri/ /index.html;
                add_header Cache-Control "no-cache, no-store, must-revalidate";
                add_header Pragma no-cache;
                add_header Expires 0;
            }
        }
    }

  default.conf: |
    server {
        listen 8080;
        server_name _;
        root /usr/share/nginx/html;
        index index.html;

        # Health check endpoint
        location /health {
            access_log off;
            return 200 "healthy\n";
            add_header Content-Type text/plain;
        }

        # Security
        location ~ /\. {
            deny all;
            access_log off;
            log_not_found off;
        }

        # Static assets with caching
        location ~* \.(jpg|jpeg|png|gif|ico|css|js|woff|woff2|ttf|eot|svg)$ {
            expires 1y;
            add_header Cache-Control "public, immutable";
            add_header X-Content-Type-Options nosniff;
            access_log off;
        }

        # HTML files with shorter cache
        location ~* \.html$ {
            expires 1h;
            add_header Cache-Control "public, must-revalidate";
        }

        # SPA fallback
        location / {
            try_files $uri $uri/ /index.html;
            add_header Cache-Control "no-cache, no-store, must-revalidate";
            add_header Pragma no-cache;
            add_header Expires 0;
        }
    }
{{- end }}