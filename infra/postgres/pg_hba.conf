# PostgreSQL Host-Based Authentication Configuration
# Production High-Security Configuration

# TYPE  DATABASE        USER            ADDRESS                 METHOD

# Local connections (Unix domain socket)
local   all             postgres                                peer
local   all             all                                     md5

# IPv4 local connections:
host    all             all             127.0.0.1/32            md5

# IPv6 local connections:
host    all             all             ::1/128                 md5

# Application connections from Kubernetes cluster
# Allow specific CIDR blocks for production
host    mariia_production mariia_app_user  10.0.0.0/8              md5
host    mariia_production mariia_read_user  10.0.0.0/8              md5
host    mariia_staging   mariia_app_user  10.0.0.0/8              md5

# Database replication connections
# Replication user from replication servers
host    replication     replicator       10.0.0.0/8              md5
host    replication     replicator       ::/0                    md5

# Monitoring and backup connections
# Allow monitoring from monitoring servers
host    all             monitoring_user  10.0.30.0/24            md5
host    all             backup_user      10.0.40.0/24            md5

# Administrative connections (restricted)
# Allow admin access from admin bastion hosts only
host    all             postgres        10.0.50.0/24            md5
host    all             postgres        203.0.113.0/24          md5

# External service connections (VPN only)
# Allow specific external services via VPN
host    mariia_production external_service 198.51.100.0/24     md5
host    mariia_production analytics_service 198.51.100.0/24     md5

# Health check connections (no authentication required for monitoring)
host    all             all             169.254.169.254/32      trust

# Security rules:
# 1. Reject all other connections
# 2. Enforce SSL for all external connections
# 3. Use strong authentication methods
# 4. Limit connection attempts

# SSL Configuration
# Require SSL for all external connections
hostssl all             all             0.0.0.0/0               md5 clientcert=1
hostssl all             all             ::/0                    md5 clientcert=1

# Connection pooling (PgBouncer) configuration
# Allow connections from PgBouncer
host    all             all             10.0.20.0/24            md5

# Read replica specific configurations
# Allow read-only access from application servers
host    mariia_production mariia_read_user  10.0.11.0/24            md5
host    mariia_production mariia_read_user  10.0.12.0/24            md5
host    mariia_production mariia_read_user  10.0.13.0/24            md5

# Database-specific access controls
# Restrict access to sensitive tables
host    mariia_sensitive_data admin_user     10.0.0.0/8              md5
host    mariia_payment_data   payment_user    10.0.0.0/8              md5
host    mariia_user_data      app_user        10.0.0.0/8              md5

# Maximum connection limits per user/role
# These are enforced at the role level in PostgreSQL
# mariia_app_user: 200 connections
# mariia_read_user: 50 connections
# replicator: 10 connections
# monitoring_user: 5 connections
# backup_user: 2 connections

# Special connection rules for high-availability scenarios
# Allow fallback connections from replica servers
host    mariia_production replicator       10.0.21.0/24            md5
host    mariia_production replicator       10.0.22.0/24            md5

# Rate limiting rules (PostgreSQL 14+)
# Limit connection attempts from suspicious sources
# This requires pg_stat_activity monitoring and external tools