# PostgreSQL Configuration for Production High-Availability Cluster
# Optimized for high-traffic booking platform

# CONNECTION SETTINGS
# ------------------
max_connections = 400                    # Maximum number of concurrent connections
superuser_reserved_connections = 3         # Reserved connections for superusers
unix_socket_directories = '/var/run/postgresql'
listen_addresses = '*'                    # Listen on all interfaces
port = 5432

# MEMORY SETTINGS
# ---------------
shared_buffers = 8GB                     # Shared memory for caching (25% of RAM)
effective_cache_size = 24GB               # Total system cache memory (75% of RAM)
work_mem = 64MB                          # Memory for query operations
maintenance_work_mem = 1GB                # Memory for maintenance operations
checkpoint_completion_target = 0.9        # Target checkpoint completion
wal_buffers = 64MB                       # WAL buffers
autovacuum_work_mem = -1                  # Use maintenance_work_mem for autovacuum

# WAL (Write-Ahead Logging) FOR REPLICATION
# -----------------------------------------
wal_level = replica                       # Minimal level for logical replication
max_wal_senders = 10                     # Number of concurrent WAL sender processes
max_replication_slots = 10                # Number of replication slots
wal_keep_size = 2GB                      # Minimum WAL size to retain
archive_mode = on                        # Enable WAL archiving
archive_command = 'rsync -a %p /var/lib/postgresql/wal_archive/%f'
archive_timeout = 300                    # Archive WALs every 5 minutes
wal_compression = on                      # Compress full page writes
wal_log_hints = on                       # Log hints for WAL recovery

# CHECKPOINT SETTINGS
# ------------------
checkpoint_timeout = 15min                # Maximum time between checkpoints
checkpoint_warning = 30s                 # Warning before checkpoint timeout
max_wal_size = 4GB                       # Maximum WAL size between checkpoints
min_wal_size = 1GB                       # Minimum WAL size between checkpoints

# REPLICATION SETTINGS
# --------------------
hot_standby = on                          # Allow read-only queries on standby
max_standby_archive_delay = 30s           # Max delay for archive recovery
max_standby_streaming_delay = 30s        # Max delay for streaming recovery
wal_receiver_status_interval = 10s        # Status update interval
hot_standby_feedback = on                 # Standby provides feedback to primary
synchronous_commit = remote_apply          # Wait for remote commit confirmation

# STATISTICS AND MONITORING
# ------------------------
track_activities = on                     # Track session activities
track_counts = on                         # Track row-level statistics
track_io_timing = on                      # Track I/O timing
track_functions = all                      # Track function calls
track_activity_query_size = 2048          # Query size for pg_stat_activity
log_min_duration_statement = 1000         # Log queries taking longer than 1 second
log_checkpoints = on                       # Log checkpoints
log_connections = on                      # Log client connections
log_disconnections = on                   # Log client disconnections
log_lock_waits = on                       # Log long lock waits
log_temp_files = 10MB                     # Log temporary files larger than 10MB
log_autovacuum_min_duration = 0           # Log all autovacuum activity

# AUTOVACUUM SETTINGS
# -------------------
autovacuum = on                            # Enable autovacuum
autovacuum_max_workers = 6                # Number of autovacuum workers
autovacuum_naptime = 30s                  # Time between autovacuum runs
autovacuum_vacuum_threshold = 50          # Minimum rows to trigger vacuum
autovacuum_vacuum_scale_factor = 0.1      # Fraction of table size to trigger vacuum
autovacuum_analyze_threshold = 50          # Minimum rows to trigger analyze
autovacuum_analyze_scale_factor = 0.05     # Fraction of table size to trigger analyze
autovacuum_vacuum_cost_delay = 10ms        # Vacuum cost delay
autovacuum_vacuum_cost_limit = 2000       # Vacuum cost limit

# QUERY PLANNER SETTINGS
# ---------------------
random_page_cost = 1.1                    # Cost for non-sequential page reads
effective_io_concurrency = 200              # Concurrent I/O capacity for SSDs
seq_page_cost = 1.0                       # Cost for sequential page reads
cpu_tuple_cost = 0.01                     # Cost for CPU tuple processing
cpu_index_tuple_cost = 0.005              # Cost for CPU index tuple processing
default_statistics_target = 1000           # Statistics collection detail

# INVESTIGATOR AND LOCKING
# -----------------------
log_min_error_statement = error             # Log all error statements
deadlock_timeout = 1s                     # Time to wait for deadlock detection
lock_timeout = 30s                         # Maximum time to wait for lock
idle_in_transaction_session_timeout = 10min # Timeout for idle transactions
statement_timeout = 300s                    # Maximum statement execution time
transaction_timeout = 300s                  # Maximum transaction duration

# LOGGING CONFIGURATION
# --------------------
logging_collector = on                     # Enable logging to files
log_directory = 'pg_log'                   # Directory for log files
log_filename = 'postgresql-%Y-%m-%d_%H%M%S.log'  # Log file naming
log_file_mode = 0600                       # Log file permissions
log_truncate_on_rotation = on               # Truncate log files on rotation
log_rotation_age = 1d                       # Rotate logs daily
log_rotation_size = 100MB                  # Rotate logs at 100MB
log_line_prefix = '%t [%p]: [%l-1] user=%u,db=%d,app=%a,client=%h '

# CLIENT CONNECTION DEFAULTS
# ---------------------------
default_text_search_config = 'pg_catalog.english'
timezone = 'UTC'
lc_messages = 'en_US.UTF-8'
lc_monetary = 'en_US.UTF-8'
lc_numeric = 'en_US.UTF-8'
lc_time = 'en_US.UTF-8'
default_encoding = 'UTF8'

# MARIIA-SPECIFIC SETTINGS
# ----------------------
# Optimizations for booking platform workloads

# Connection pooling
shared_preload_libraries = 'pg_stat_statements,auto_explain'  # Preload useful extensions
pg_stat_statements.max = 10000          # Number of tracked statements
pg_stat_statements.track = all           # Track all statements
auto_explain.log_min_duration = 1000    # Explain slow queries
auto_explain.log_analyze = true
auto_explain.log_verbose = true
auto_explain.log_format = json

# High-frequency read optimizations
effective_io_concurrency = 200          # For SSD storage
maintenance_work_mem = 1GB              # For index builds
max_parallel_workers_per_gather = 4     # Parallel query workers
max_parallel_workers = 16                # Total parallel workers
max_parallel_maintenance_workers = 4       # Parallel maintenance workers

# Write-heavy optimizations
wal_writer_delay = 200ms                 # WAL write delay
commit_delay = 0                         # No artificial commit delay
synchronous_commit = remote_apply         # Balanced performance/durability

# Memory for sorting and hashing
effective_cache_size = 24GB             # System cache estimate
work_mem = 64MB                          # Per-operation memory
maintenance_work_mem = 1GB               # Maintenance operations
temp_file_limit = 10GB                   # Limit temporary file usage

# JIT compilation settings for CPU-intensive queries
jit = on                                 # Enable JIT compilation
jit_inline_above_cost = 500000            # Inline threshold
jit_optimize_above_cost = 500000         # Optimization threshold
jit_explain_above_cost = 500000           # Explain threshold

# EXTENSION CONFIGURATION
# ----------------------
# pg_stat_statements (query performance)
pg_stat_statements.max = 10000
pg_stat_statements.track = all
pg_stat_statements.track_utility = off
pg_stat_statements.save = on

# auto_explain (slow query analysis)
auto_explain.log_min_duration = 1000
auto_explain.log_analyze = on
auto_explain.log_verbose = on
auto_explain.log_buffers = on
auto_explain.log_timing = on
auto_explain.log_triggers = on
auto_explain.log_wal = on
auto_explain.format = json

# CUSTOM GUCs (Grand Unified Configuration)
# ----------------------------------------
mariia.max_concurrent_bookings = 100     # Max concurrent booking operations
mariia.booking_timeout_ms = 5000         # Booking operation timeout
mariia.cache_ttl_seconds = 300           # Default cache TTL
mariia.enable_query_cache = true         # Enable query result caching
mariia.log_slow_bookings = true          # Log slow booking operations